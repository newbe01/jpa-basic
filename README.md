# JPA
 - JavaPeristenceAPI
 - SQL 중심적인 개발에서 객체중심으로 개발이 가능해 진다.
 - 성능, 생산성과 유지보수, 패러다임의 불일치해결 등 많은효과를 볼 수 있다.

### JPA의 시작
 - EntityManagerFactory는 하나만생성해서 APK전체에서 공유한다.
 - EntityManager는 스레드간에 공유X
 - JPA의 모든 데이터변경은 트랜잭션 안에서 실행해야한다.

### 영속성 컨텍스트
 - JPA를 이해하는데 가장 중요한용어로, "엔티티를 영구저장하는 환경이라는뜻"
 - 논리적인 개념으로 EntityManager를 통해 영속성 컨텍스트에 접근한다.
 - 비영속, 영속, 준영속, 삭제 네가지의 생명주기를 가진다.
 - 1차캐시, 동일성, 변경감지, 지연로딩, 쓰기지연등의 이점이 존재한다.
 - 영속성 컨텍스트의 변경내용을 DB에 반영하는 `flush`가 있다.
 - `flush`발생시 변경감지, 수정된 엔티티 등록, 쿼리전송등이 발생한다.
 - JPQL쿼리 실행시 자동으로 flush가 호출된다.
 - `flush`는 영속성 컨텍스트를 비우지않고, 변경내용을 db에 동기화한다.

### 엔티티 매핑
###### @Entity
```agsl
    @Entity
    public class Entity {
   
    }
```
 - `@Entity`가 붙은 클래스는 JPA가 관리, 엔티티라한다. 
 - JPA를 사용해 테이블과 매핑할 클래스는 필수로 붙여야한다.
 - 기본생성자를 필수로 가져야하며, `final`, `enum`, `interface`,`inner` class 사용 X
 - 저장할 필드에 `final`을 사용하면 안된다.

###### 필드와 컬럼 매핑
 - `@Column`을 사용해 컬럼을 매핑할 수 있다.
 - `@Column` 의 속성들을 사용해 db컬럼의 이름, nullable, unique 등 제약을 걸 수있다.
 - `Enum`타입을 사용할 때 `@Enumerated(ㄷEnumType.STRING)`을 사용해줘야 한다.
 - 길이가 큰 자료형일 경우 `@Lob`를 사용해 만들 수 있다.

###### 기본 키 매핑
```
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
```
 - 기본키를 직접 할당 할 때는 `@Id`만 사용하면된다.
 - 자동생성 할 때는 `@GeneratedValue()`를 사용해 만들 수 있다.

### 연관관계 매핑 기초
 - 객체를 테이블에 맞추어 데이터중심으로 모델링하면, 협력관계를 만들 수 없다.
 - 테이블은 외래키 조인을 사용해 연관된 테이블을 찾지만, 객체는 참조를 사용해 찾는다.
 - 객체를 양방향으로 참조하려면 단방향 영관관계를 2번 만들어주어야 한다.
 - 양방향 매핑시, 두 관계중 하나를 연관관계의 주인으로 지정해 한쪽에서만 값을 다룰수 있게, 다른쪽은 읽기만 가능하게 해야한다.
 - 주인이 아니면 `mappedBy`속성으로 주인을 지정해주어야한다. 외래키를 가진쪽을 주인으로 하는것이 좋다.
 - 단방향 매핑만으로 이미 연관관계 매핑은 완료. 양방향 매핑은 반대방향으로 조회기능이 추가.

### 다양한 연관관계 매핑
 - 테이블은 외래키 하나로 양쪽 조인이 가능해, 방향이라는 개념이 없음.
 - 객체는 참조용 필드가 있는 쪽으로만 참조가 가능. 한쪽만 참조하면 단방향, 양쪽이 참조하면 양방향

#### N : 1
##### 단방향
 - 가장많이 사용하는 연관관계, 반대는 1:N관계
##### 양방향
 - 외래키가 있는 쪽이 연관관계의 주인이며, 양쪽을 서로 참조하도록 개발

#### 1 : N
##### 단방향
 - 테이블 일대다 관계는 항상 N 쪽에 왜래키가 있으므로, 1:N 단방향은 1이 연관관계의 주인.
 - 객체와 테이블 차이 때문에 반대편 테이블의 외래키를 관리하는 특이한 구조.
 - `@JoinColumn`을 반드시 사용해 주어야한다.
 - 엔티티가 관리하는 외래키가 다른테이블에있고, 관리를 위해 추가로 Update를 해야한다.
 - 1:N 보다는 N:1을 사용하는것을 지향
##### 양방향
 - 공식적으로 존재하지 않는 매핑
 - `@JoinColumn(insertable=false, updatable=flase`를 사용
 - 읽기전용 필드를 사용해, 양방향처럼 사용하는 방법. N:1 양방향을 권장
 
#### 1 : 1
 - 반대 관계도 1:1 관계이다.
 - 외래키를 어느쪽에서도 설정할 수 있다.
 - 외래키에 DB unique 설정을 추가해야한다.

#### N : M
 - RDBMS는 테이블 2개로 다대다 관계를 표현할 수 없음.
 - `@ManyToMany`를 사용하고, `@JoinTable`로 연결을 지정한다.
 - 